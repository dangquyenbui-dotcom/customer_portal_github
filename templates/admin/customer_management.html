{% extends "base.html" %}

{% block title %}Manage Customers - Admin{% endblock %}

{% block navbar_title %}üë• Manage Customers{% endblock %}

{% block nav_links %}
    <span style="color: white; margin-right: 15px;">Admin: {{ session.admin.username }}</span>
    <a href="{{ url_for('admin_panel.panel') }}">Admin Dashboard</a>
    <a href="{{ url_for('main.admin_logout') }}">Admin Logout</a>
{% endblock %}

{% block styles %}
{# admin.css is already included in base.html #}
<style>
    .actions-bar { margin-bottom: 20px; }
    
    .filter-section { 
        flex-grow: 1; 
    }
    #filterForm {
        width: 100%; 
    }
    .search-bar { 
        position: relative; 
        flex-grow: 1; 
        margin-bottom: 0; 
    }
    input.search-input { 
        width: 100%; 
        padding: 10px 15px 10px 40px; 
    }
    .search-icon { 
        position: absolute; 
        left: 15px; 
        top: 50%; 
        transform: translateY(-50%); 
        color: var(--text-tertiary);
        z-index: 1;
    }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .checkbox-group label { margin-left: 5px; }
    
    .checkbox-container {
        max-height: 200px;
        overflow-y: auto;
        border: 2px solid var(--input-border);
        border-radius: 8px;
        padding: 10px;
        background: var(--input-bg);
    }
    .checkbox-container label {
        display: block; 
        margin-bottom: 5px;
        font-weight: normal; 
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }
    .checkbox-container label input {
        margin-right: 8px;
        transform: translateY(1px);
    }
    .checkbox-container label:hover {
        background-color: var(--bg-hover);
    }
    .checkbox-container hr {
        border: none;
        border-top: 1px solid var(--border-primary);
        margin: 8px 0;
    }
    
    /* === NEW: Style for reset password button === */
    .btn-reset-pw {
        background: var(--btn-info-bg);
        color: var(--btn-info-text);
    }
    .btn-reset-pw:hover {
        background: var(--btn-info-hover);
    }
</style>
{% endblock %}

{% block content %}
<div class="header-card">
    <h1>Customer Account Management</h1>
    <p>Create, view, edit, and manage customer portal access.</p>
</div>

<div id="alerts"></div> {# For JS alerts from common.js #}

<div class="actions-bar">
     <div class="filter-section">
        <form method="GET" action="{{ url_for('admin_customers.manage_customers') }}" id="filterForm" style="display: flex; gap: 15px; align-items: center;">
            <div class="search-bar">
                <span class="search-icon">üîç</span>
                <input type="text" name="search" class="search-input" placeholder="Search Name, Email, ERP Name..." value="{{ search_term or '' }}">
            </div>
            
             <select name="status" class="filter-select" onchange="document.getElementById('filterForm').submit()">
                <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
            </select>
            <button type="submit" class="btn btn-secondary">Filter</button>
            <a href="{{ url_for('admin_customers.manage_customers') }}" class="btn btn-secondary">Reset</a>
         </form>
    </div>
    <button class="btn btn-primary" onclick="openAddModal()">
        + Add New Customer
    </button>
</div>

<div class="data-table">
    {% if customers %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>ERP Customer Name(s)</th>
                <th>Status</th>
                <th>Last Login</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in customers %}
            <tr>
                <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                <td>{{ customer.email }}</td>
                <td>{{ customer.erp_customer_name.replace('|', ', ') }}</td>
                <td>
                    {% if customer.is_active %}
                    <span class="status-badge status-active">Active</span>
                    {% else %}
                    <span class="status-badge status-inactive">Inactive</span>
                    {% endif %}
                </td>
                <td>{{ customer.last_login_date.strftime('%Y-%m-%d %H:%M') if customer.last_login_date else 'Never' }}</td>
                <td>
                    <div class="actions">
                        <button class="btn btn-secondary btn-sm" onclick='openEditModal({{ customer | tojson | safe }})'>
                            ‚úèÔ∏è Edit
                        </button>
                        
                        <!-- === NEW: Reset Password Button === -->
                        <button class="btn btn-info btn-sm"
                                id="reset-btn-{{ customer.customer_id }}"
                                onclick="triggerAdminReset({{ customer.customer_id }}, '{{ customer.first_name }} {{ customer.last_name }}', this)">
                            üîë Reset PW
                        </button>
                        <!-- === END NEW === -->
                        
                        {% if customer.is_active %}
                        <button class="btn btn-secondary btn-sm"
                                onclick="deactivateCustomer({{ customer.customer_id }}, '{{ customer.first_name }} {{ customer.last_name }}')">
                            üö´ Deactivate
                        </button>
                        {% else %}
                         <button class="btn btn-info btn-sm"
                                 onclick="reactivateCustomer({{ customer.customer_id }}, '{{ customer.first_name }} {{ customer.last_name }}')">
                             ‚úÖ Reactivate
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">üë•</div>
        <h3>No Customers Found</h3>
        <p>No customers match the current filter criteria, or none have been added yet.</p>
    </div>
    {% endif %}
</div>


<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="dtUtils.closeModal('addModal')">&times;</span>
        <h2>Add New Customer</h2>
        <form id="addForm" method="POST" action="{{ url_for('admin_customers.add_customer') }}">
            <div class="form-row">
                <div class="form-group">
                    <label for="first_name">First Name *</label>
                    <input type="text" id="first_name" name="first_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="last_name">Last Name *</label>
                    <input type="text" id="last_name" name="last_name" class="form-control" required>
                </div>
            </div>
             <div class="form-group">
                <label for="email">Email Address *</label>
                <input type="email" id="email" name="email" class="form-control" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="password">Password *</label>
                <input type="password" id="password" name="password" class="form-control" required autocomplete="new-password">
                <small>Minimum 8 characters. User will be forced to change this on first login.</small>
            </div>
            
            <div class="form-group">
                <label for="erp_customer_name_add">ERP Customer Name(s) *</label>
                <div id="erp_customer_name_add" class="checkbox-container">
                    <label>
                        <input type="checkbox" name="erp_customer_name" value="All" class="erp-checkbox-add" onchange="handleAllCheck(this, 'add')">
                        <strong>All Customers (Overrides all others)</strong>
                    </label>
                    <hr>
                    {% for name in erp_customer_names %}
                    <label>
                        <input type="checkbox" name="erp_customer_name" value="{{ name }}" class="erp-checkbox-add" onchange="handleCustomerCheck(this, 'add')">
                        {{ name }}
                    </label>
                    {% endfor %}
                </div>
                <small>Must select at least one customer or "All".</small>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="dtUtils.closeModal('addModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Customer</button>
            </div>
        </form>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="dtUtils.closeModal('editModal')">&times;</span>
        <h2>Edit Customer</h2>
        <form id="editForm"> {# Will be submitted via JS #}
            <input type="hidden" id="edit_customer_id" name="customer_id">
             <div class="form-row">
                <div class="form-group">
                    <label for="edit_first_name">First Name *</label>
                    <input type="text" id="edit_first_name" name="edit_first_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="edit_last_name">Last Name *</label>
                    <input type="text" id="edit_last_name" name="edit_last_name" class="form-control" required>
                </div>
            </div>
             <div class="form-group">
                <label for="edit_email">Email Address *</label>
                <input type="email" id="edit_email" name="edit_email" class="form-control" required autocomplete="off">
            </div>
            
             <div class="form-group">
                <label for="erp_customer_name_edit">ERP Customer Name(s) *</label>
                <div id="erp_customer_name_edit" class="checkbox-container">
                    <label>
                        <input type="checkbox" name="edit_erp_customer_name" value="All" class="erp-checkbox-edit" onchange="handleAllCheck(this, 'edit')">
                        <strong>All Customers (Overrides all others)</strong>
                    </label>
                    <hr>
                    {% for name in erp_customer_names %}
                    <label>
                        <input type="checkbox" name="edit_erp_customer_name" value="{{ name }}" class="erp-checkbox-edit" onchange="handleCustomerCheck(this, 'edit')">
                        {{ name }}
                    </label>
                    {% endfor %}
                </div>
                <small>Must select at least one customer or "All".</small>
            </div>
            
             <div class="form-group">
                <label for="edit_password">New Password (Optional)</label>
                <input type="password" id="edit_password" name="edit_password" class="form-control" autocomplete="new-password">
                <small>Leave blank to keep current password. User will be forced to reset if new one is set.</small>
            </div>
            <div class="form-group checkbox-group">
                 <input type="checkbox" id="edit_is_active" name="edit_is_active" value="true">
                 <label for="edit_is_active">Account Active</label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="dtUtils.closeModal('editModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Customer</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // === Checkbox logic helpers ===
    function handleAllCheck(allCheckbox, modalType) {
        const selector = `.erp-checkbox-${modalType}`;
        const otherCheckboxes = document.querySelectorAll(selector + ':not([value="All"])');
        
        if (allCheckbox.checked) {
            otherCheckboxes.forEach(cb => { 
                cb.checked = false;
                cb.disabled = true;
            });
        } else {
            otherCheckboxes.forEach(cb => { 
                cb.disabled = false;
            });
        }
    }

    function handleCustomerCheck(customerCheckbox, modalType) {
        const allCheckbox = document.querySelector(`.erp-checkbox-${modalType}[value="All"]`);
        
        if (customerCheckbox.checked && allCheckbox.checked) {
            allCheckbox.checked = false;
            const otherCheckboxes = document.querySelectorAll(`.erp-checkbox-${modalType}:not([value="All"])`);
            otherCheckboxes.forEach(cb => cb.disabled = false);
        }
    }

    function openAddModal() {
        dtUtils.resetForm('addForm');
        document.querySelectorAll('.erp-checkbox-add').forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
        });
        dtUtils.openModal('addModal');
    }

    function openEditModal(customerData) {
        document.getElementById('edit_customer_id').value = customerData.customer_id;
        document.getElementById('edit_first_name').value = customerData.first_name || '';
        document.getElementById('edit_last_name').value = customerData.last_name || '';
        document.getElementById('edit_email').value = customerData.email || '';
        
        const editCheckboxes = document.querySelectorAll('.erp-checkbox-edit');
        editCheckboxes.forEach(cb => {
             cb.checked = false;
             cb.disabled = false;
        });
        
        const selected_names = customerData.erp_customer_name ? customerData.erp_customer_name.split('|') : [];
        let isAll = false;
        editCheckboxes.forEach(cb => {
            if (selected_names.includes(cb.value)) {
                cb.checked = true;
                if (cb.value === 'All') {
                    isAll = true;
                }
            }
        });
        
        if (isAll) {
             document.querySelectorAll('.erp-checkbox-edit:not([value="All"])').forEach(cb => {
                 cb.disabled = true;
             });
        }
        
        document.getElementById('edit_password').value = ''; 
        document.getElementById('edit_is_active').checked = customerData.is_active || false;
        dtUtils.openModal('editModal');
    }

    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const customerId = document.getElementById('edit_customer_id').value;
        const form = e.target;
        
        document.querySelectorAll('.erp-checkbox-edit').forEach(cb => cb.disabled = false);

        const formData = new FormData(form);
        const submitButton = form.querySelector('button[type="submit"]');

        const isActive = document.getElementById('edit_is_active').checked;
        formData.set('edit_is_active', isActive ? 'true' : 'false');

        submitButton.disabled = true;
        submitButton.textContent = 'Updating...';

        fetch(`/admin/customers/edit/${customerId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                dtUtils.showAlert(data.message, 'success');
                dtUtils.closeModal('editModal');
                setTimeout(() => window.location.reload(), 1000);
            } else {
                dtUtils.showAlert(data.message, 'error');
                handleAllCheck(document.querySelector('.erp-checkbox-edit[value="All"]'), 'edit');
            }
        })
        .catch(error => {
            console.error('Update error:', error);
            dtUtils.showAlert('An error occurred during the update.', 'error');
            handleAllCheck(document.querySelector('.erp-checkbox-edit[value="All"]'), 'edit');
        })
        .finally(() => {
            submitButton.disabled = false;
            submitButton.textContent = 'Update Customer';
        });
    });

    function deactivateCustomer(customerId, customerName) {
        dtUtils.deleteItem(
            `/admin/customers/deactivate/${customerId}`,
            customerName,
            (data) => {}
        );
    }

    function reactivateCustomer(customerId, customerName) {
        if (confirm(`Are you sure you want to reactivate "${customerName}"?`)) {
            fetch(`/admin/customers/reactivate/${customerId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                dtUtils.showAlert(data.message, data.success ? 'success' : 'error');
                if (data.success) {
                    setTimeout(() => window.location.reload(), 1000);
                }
            })
            .catch(error => {
                console.error('Reactivation error:', error);
                dtUtils.showAlert('An error occurred during reactivation.', 'error');
            });
        }
    }
    
    // === NEW: Admin Password Reset Function ===
    function triggerAdminReset(customerId, customerName, buttonElement) {
        const originalText = buttonElement.innerHTML;
        if (!confirm(`Are you sure you want to reset the password for "${customerName}"?\n\nA new temporary password will be generated and emailed to them.`)) {
            return;
        }

        buttonElement.disabled = true;
        buttonElement.innerHTML = 'Sending...';

        fetch(`/admin/customers/admin-reset-password/${customerId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            dtUtils.showAlert(data.message, data.success ? 'success' : 'error');
        })
        .catch(error => {
            console.error('Admin Reset error:', error);
            dtUtils.showAlert('An error occurred during the password reset.', 'error');
        })
        .finally(() => {
            buttonElement.disabled = false;
            buttonElement.innerHTML = originalText;
        });
    }

</script>
{% endblock %}
